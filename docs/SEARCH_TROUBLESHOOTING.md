# 🔍 搜索功能故障排查指南

## 问题：搜索功能无法使用，点击无反应

如果您遇到搜索功能无法使用的问题，请按照以下步骤排查：

## ✅ 快速检查清单

### 1. 检查地图是否已加载

**症状**：搜索按钮是灰色（禁用状态）

**解决方法**：
- 等待地图完全加载（通常需要 2-5 秒）
- 查看搜索框下方是否显示 "⏳ 地图加载中，请稍候..."
- 如果长时间未加载，刷新页面重试

### 2. 检查是否输入了搜索关键词

**症状**：搜索按钮是灰色，提示 "请输入搜索关键词"

**解决方法**：
- 在搜索框中输入地点名称
- 例如："北京故宫"、"上海外滩"、"成都火锅"

### 3. 检查 API Key 配置

**症状**：地图显示但搜索无反应，控制台显示 API 相关错误

**解决方法**：

#### 步骤 1：检查环境变量

打开 `.env.local` 文件，确认包含：

```bash
NEXT_PUBLIC_AMAP_KEY=你的高德地图Key
```

#### 步骤 2：验证 API Key

1. 登录 [高德开放平台控制台](https://console.amap.com/)
2. 检查 Key 是否有效
3. 确认 Key 的服务平台选择了 **"Web 端（JS API）"**
4. 检查 Key 是否有搜索服务的权限

#### 步骤 3：重启服务器

```bash
# 停止服务器（Ctrl+C）
npm run dev
```

### 4. 检查浏览器控制台

**步骤**：
1. 按 `F12` 打开开发者工具
2. 切换到 "Console" 标签
3. 点击搜索按钮
4. 查看控制台输出

**正常情况应该看到**：
```
🔍 开始搜索: 北京故宫
地图状态: { isLoaded: true, hasMap: true }
✅ 开始调用搜索 API
✅ PlaceSearch 插件加载成功
🔍 搜索关键词: 北京故宫
📊 搜索结果状态: complete
✅ 搜索成功，找到 10 个结果
```

**如果看到错误**：
- `❌ 地图未加载完成` → 等待地图加载
- `❌ 高德地图 API 未加载` → 检查 API Key 配置
- `❌ 搜索失败` → 查看具体错误信息

### 5. 检查网络连接

**症状**：搜索请求超时或失败

**解决方法**：
- 检查网络连接是否正常
- 尝试刷新页面
- 检查是否有防火墙或代理阻止了请求

## 🔧 详细排查步骤

### 步骤 1：打开浏览器控制台

1. 按 `F12` 打开开发者工具
2. 切换到 "Console" 标签
3. 清空控制台（点击清除按钮）

### 步骤 2：尝试搜索

1. 在搜索框输入 "北京天安门"
2. 点击搜索按钮或按 Enter
3. 观察控制台输出

### 步骤 3：根据控制台信息排查

#### 情况 A：没有任何输出

**可能原因**：
- 事件监听器未绑定
- JavaScript 错误阻止了执行

**解决方法**：
1. 刷新页面
2. 检查是否有其他 JavaScript 错误
3. 尝试清除浏览器缓存

#### 情况 B：显示 "地图未加载完成"

**解决方法**：
1. 等待地图完全加载（查看地图是否显示）
2. 如果长时间未加载，检查 API Key 配置
3. 刷新页面重试

#### 情况 C：显示 "高德地图 API 未加载"

**解决方法**：
1. 检查 `.env.local` 文件中的 `NEXT_PUBLIC_AMAP_KEY`
2. 确认 API Key 格式正确（没有多余空格）
3. 重启开发服务器
4. 检查浏览器 Network 标签，查看是否有 API 加载失败

#### 情况 D：显示 "搜索失败"

**查看具体错误信息**：
- `INVALID_USER_KEY` → API Key 无效
- `DAILY_QUERY_OVER_LIMIT` → 超出每日配额
- `ACCESS_TOO_FREQUENT` → 请求过于频繁
- `INVALID_PARAMS` → 参数错误

**解决方法**：
- 根据错误代码查看 [高德地图错误码说明](https://lbs.amap.com/api/webservice/guide/tools/info)
- 检查 API Key 权限
- 等待一段时间后重试

## 🎯 常见问题解决

### 问题 1：搜索按钮点击无反应

**可能原因**：
1. 地图未加载完成
2. 搜索关键词为空
3. JavaScript 错误

**解决步骤**：
1. ✅ 等待地图加载完成
2. ✅ 输入搜索关键词
3. ✅ 打开控制台查看错误
4. ✅ 刷新页面重试

### 问题 2：搜索无结果

**可能原因**：
1. 搜索关键词不准确
2. 地点不在服务范围内
3. API 配额用完

**解决方法**：
1. 尝试更具体的关键词（如："北京故宫" 而不是 "故宫"）
2. 确认搜索地点在中国大陆范围内
3. 检查 API 配额是否充足

### 问题 3：搜索结果不显示在地图上

**可能原因**：
1. 地图实例问题
2. 标记添加失败

**解决方法**：
1. 查看控制台是否有错误
2. 尝试刷新页面
3. 检查地图是否正常显示

### 问题 4：搜索很慢或超时

**可能原因**：
1. 网络问题
2. API 响应慢
3. 服务器负载高

**解决方法**：
1. 检查网络连接
2. 等待一段时间后重试
3. 尝试其他搜索关键词

## 📊 调试技巧

### 技巧 1：使用控制台测试

在浏览器控制台输入以下代码测试搜索功能：

```javascript
// 检查地图是否加载
console.log('地图加载状态:', window.AMap ? '已加载' : '未加载')

// 检查地图实例
const mapElement = document.querySelector('[class*="map"]')
console.log('地图元素:', mapElement)
```

### 技巧 2：检查网络请求

1. 打开开发者工具
2. 切换到 "Network" 标签
3. 点击搜索按钮
4. 查看是否有请求发送
5. 检查请求的 URL 和响应

### 技巧 3：验证 API Key

在浏览器控制台输入：

```javascript
// 检查环境变量（如果暴露了）
console.log('API Key 配置:', process.env.NEXT_PUBLIC_AMAP_KEY ? '已配置' : '未配置')
```

## 🔍 验证搜索功能

### 测试步骤

1. **打开地图**
   - 点击 "显示地图" 按钮
   - 等待地图完全加载

2. **输入搜索关键词**
   - 在搜索框输入："北京天安门"
   - 确认搜索框不是禁用状态

3. **执行搜索**
   - 点击搜索按钮或按 Enter
   - 观察控制台输出

4. **检查结果**
   - 应该看到搜索结果列表
   - 地图上应该显示标记点
   - 控制台应该显示成功日志

### 预期结果

- ✅ 搜索框可以输入
- ✅ 搜索按钮可以点击（非禁用状态）
- ✅ 控制台显示搜索日志
- ✅ 显示搜索结果列表
- ✅ 地图上显示标记点
- ✅ 可以点击搜索结果定位

## 📞 获取帮助

如果以上方法都无法解决问题：

1. **收集信息**：
   - 浏览器控制台的完整错误信息
   - Network 标签中的请求详情
   - 您的 API Key 配置情况（不要分享 Key 本身）

2. **查看文档**：
   - [高德地图配置指南](./AMAP_SETUP.md)
   - [地图使用指南](./MAP_USAGE_GUIDE.md)
   - [高德地图官方文档](https://lbs.amap.com/api/javascript-api/summary)

3. **检查示例**：
   - 查看 [高德地图示例中心](https://lbs.amap.com/demo/list/js-api)
   - 对比示例代码和项目代码

## ✅ 快速修复清单

- [ ] 地图已完全加载
- [ ] 已输入搜索关键词
- [ ] API Key 已正确配置
- [ ] 已重启开发服务器
- [ ] 浏览器控制台无错误
- [ ] 网络连接正常
- [ ] API Key 有搜索服务权限
- [ ] 搜索关键词格式正确

---

**现在搜索功能应该可以正常工作了！** 🔍✨

如果还有问题，请查看浏览器控制台的详细错误信息，或参考其他相关文档。

